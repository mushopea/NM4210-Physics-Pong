<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>PENIS</title>

    <!-- Global Variables -->
    <script type = "text/javascript">
        // = = = = = = = = = = = = = = = = =
        // Fonts
        // = = = = = = = = = = = = = = = = =
        WebFontConfig = {
            google: {
                families: ['Orbitron:700:latin']
                // sample usage: this.add.text(70, 380, “TOUCH TO\nSTART”, {font: “30px Orbitron”, align:”center”, fill:”#fff”});
            }
        };
        (function() {
            var wf = document.createElement('script');
            wf.src = ('https:'== document.location.protocol ? 'https': 'http') + '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
            wf.type = 'text / javascript';
            wf.async = 'true';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(wf, s);
        })();

        // = = = = = = = = = = = = = = = = =
        // Variables shared between states
        // = = = = = = = = = = = = = = = = =

        // sensor data
        var ipAddress;

        // game variables and limits
        var maxNumberOfPlayers = 5;
        var numberOfPlayers = 1;
        var numberOfRounds = 5;

        // player scores
        var scores = [];
        for (i = 0; i < numberOfPlayers; i++) {
            scores.push(0);
        }

    </script>

    <!-- include phaser -->
    <script type="text/javascript" src="js/phaser.min.js"></script>


    <!-- include all game states -->
    <script type="text/javascript" src="js/boot.js"></script>
    <script type="text/javascript" src="js/preloader.js"></script>
    <script type="text/javascript" src="js/mainmenu.js"></script>
    <script type="text/javascript" src="js/playermenu.js"></script>
    <script type="text/javascript" src="js/multiplayermenu.js"></script>
    <script type="text/javascript" src="js/game.js"></script>
    <script type="text/javascript" src="js/gameover.js"></script>

    <!-- include CSS -->
    <link rel="stylesheet" href="css/main.css">

</head>

<body>


<script type="text/javascript">

    // initialize game
    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
        preload: preload,
        create: create,
        update: update
    });

    // add game states (aka the game screens)
    game.state.add('Boot', SliderGame.Boot); // boot the game
    game.state.add('Preloader', SliderGame.Preloader); // show loading bar
    game.state.add('MainMenu', SliderGame.MainMenu); // ask for IP address
    game.state.add('PlayerMenu', SliderGame.PlayerMenu); // ask 1 player or multiplayer
    game.state.add('MultiplayerMenu', SliderGame.MultiplayerMenu); // enter number of players for multiplayers
    game.state.add('Game', SliderGame.Game); // the game itself
    game.state.add('GameOver', SliderGame.GameOver); // end game that shows winner, scores and "restart" button

    function preload() {

        //  Load the Google WebFont Loader script
        game.load.script('webfont', '//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js');

        game.load.image('sky', 'assets/sky.png');
        game.load.image('ground', 'assets/platform.png');
        game.load.image('star', 'assets/star.png');
        game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

        // load item images
        game.load.image('teaCup', 'assets/300.png');
        game.load.image('wineGlass', 'assets/500.png');
        game.load.image('milkBottle', 'assets/700.png');
        game.load.image('waterJug', 'assets/1000.png');
        game.load.image('beerBarrel', 'assets/2000.png');


    }

    var player;
    var platforms;
    var cursors;
    var stars;
    var score = 0;
    var scoreText;

    // = = = = = = = = = = = = = = = = =
    // Game variables
    // = = = = = = = = = = = = = = = = =

    // item values
    var numberOfItems = 5;
    var itemName = ["Tea Cup", "Wine Glass", "Milk Bottle", "Water Jug", "Beer Barrel"];
    var itemWeight = [300, 500, 700, 1000, 2000];
    var itemImage = ['teaCup', 'wineGlass', 'milkBottle', 'waterJug', 'beerBarrel'];

    // surface values
    var numberOfSurfaces = 3;
    var surfaceName = ["wood", "rubber", "ice"];
    var surfaceFriction = [0.3, 0.6, 0.05]; // source: http://www.engineeringtoolbox.com/friction-coefficients-d_778.html


    function create() {

        // connect to sensorendipity
        connect();

        // = = = = = = = = = = = = = = = = =
        // Game world
        // = = = = = = = = = = = = = = = = =

        //  We're going to be using physics, so enable the Arcade Physics system
        game.physics.startSystem(Phaser.Physics.ARCADE);

        //  A simple background for our game
        game.add.sprite(0, 0, 'sky');

        //  The platforms group contains the ground and the 2 ledges we can jump on
        platforms = game.add.group();

        //  We will enable physics for any object that is created in this group
        platforms.enableBody = true;

        // Here we create the ground.
        var ground = platforms.create(0, game.world.height - 64, 'ground');

        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        ground.scale.setTo(2, 2);

        //  This stops it from falling away when you jump on it
        ground.body.immovable = true;

        //  Now let's create two ledges
        var ledge = platforms.create(400, 400, 'ground');
        ledge.body.immovable = true;

        ledge = platforms.create(-150, 250, 'ground');
        ledge.body.immovable = true;

        // The player and its settings
        player = game.add.sprite(32, game.world.height - 150, 'dude');

        //  We need to enable physics on the player
        game.physics.arcade.enable(player);

        //  Player physics properties. Give the little guy a slight bounce.
        player.body.bounce.y = 0.2;
        player.body.gravity.y = 300;
        player.body.collideWorldBounds = true;

        //  Our two animations, walking left and right.
        player.animations.add('left', [0, 1, 2, 3], 10, true);
        player.animations.add('right', [5, 6, 7, 8], 10, true);

        //  Finally some stars to collect
        stars = game.add.group();

        //  We will enable physics for any star that is created in this group
        stars.enableBody = true;

        //  Here we'll create 12 of them evenly spaced apart
        for (var i = 0; i < 12; i++) {
            //  Create a star inside of the 'stars' group
            var star = stars.create(i * 70, 0, 'star');

            //  Let gravity do its thing
            star.body.gravity.y = 300;

            //  This just gives each star a slightly random bounce value
            star.body.bounce.y = 0.7 + Math.random() * 0.2;
        }

        //  The score
        scoreText = game.add.text(16, 16, 'score: 0', {
            fontSize: '32px',
            fill: '#000'
        });

        //  Our controls.
        cursors = game.input.keyboard.createCursorKeys();

    }

    function update() {
        var sensorValue = getSensorValue();
        console.log(sensorValue);

        //  Collide the player and the stars with the platforms
        game.physics.arcade.collide(player, platforms);
        game.physics.arcade.collide(stars, platforms);

        //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
        game.physics.arcade.overlap(player, stars, collectStar, null, this);

        //  Reset the players velocity (movement)
        player.body.velocity.x = 0;

        if (cursors.left.isDown) {
            //  Move to the left
            player.body.velocity.x = -150;

            player.animations.play('left');
        } else if (cursors.right.isDown) {
            //  Move to the right
            player.body.velocity.x = 150;

            player.animations.play('right');
        } else {
            //  Stand still
            player.animations.stop();

            player.frame = 4;
        }

        //  Allow the player to jump if they are touching the ground.
        if (cursors.up.isDown && player.body.touching.down) {
            player.body.velocity.y = -350;
        }

    }

    function collectStar(player, star) {

        // Removes the star from the screen
        star.kill();

        //  Add and update the score
        score += 10;
        scoreText.text = 'Score: ' + score;

    }


    // = = = = = = = = = = = = = = = = =
    // Sensor IP
    // = = = = = = = = = = = = = = = = =

    // Get the IP address from the textbox.
    function setIP() {
        ipAddress = document.getElementById("input_ip_address").value; // input_ip_address is the textbox that asks for the IP.
        console.log(ipAddress);
    }

    // Get the JSON data string from the IP address.
    function httpGet(theUrl) {
        var xmlHttp = null;
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", theUrl, false);
        xmlHttp.send(null);
        return xmlHttp.responseText;
    }

    // Connect the phone to the desktop game, through IP address --> call this in the first game screen
    function connect() {
        setIP();

        // Try to get the initial data of the server. If the IP is incorrect, this gives a pop-up.
        try {
            sensorJSON = JSON.parse(httpGet(ipAddress)).sensors;
        } catch (e) {
            alert("Invalid IP address");
        }
    }

    // Get the accelerometer value! --> call this every update
    function getSensorValue() {
        var sensorData = JSON.parse(httpGet(ipAddress)).sensors;

        // loops through all the sensors to find the accelerometer. O(n)? MUCH INEFFICIENT, WTF.
        sensorData.forEach(
            function(element, index) {
                console.log(element.type + ' [' + index + ']');
                if (element.type === 'linear_acceleration') {
                    return element.values[1]; // return linear_acceleration_y value, the second value in the array
                }
            }
        )
    }


</script>
</body>
</html>